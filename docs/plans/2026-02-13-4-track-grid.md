# 4-Track Dense Grid Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Display 4 tracks of 16 steps in a compact grid layout with 40×40px buttons and track labels.

**Architecture:** Extend selection signal from `Option<usize>` to `Option<(usize, usize)>` to track both track_id and step_idx. Update grid to display 4 rows (tracks 0-3) × 16 columns (steps 0-15) with track labels on the left. Update inspector header to show track number.

**Tech Stack:** Leptos 0.7 (Rust → WASM), Tailwind CSS v4, Tauri 2.x

---

## Task 1: Update SequencerState Selection Signal Type

**Files:**
- Modify: `flux-app/src/app.rs:21-24`

**Step 1: Update SequencerState struct**

Change the selection signal type to support track and step:

```rust
#[derive(Clone)]
pub struct SequencerState {
    pub current_step: ReadSignal<usize>,
    pub selected_step: RwSignal<Option<(usize, usize)>>, // (track_id, step_idx)
}
```

**Step 2: Verify compilation**

Run: `cd flux-app && cargo check`
Expected: Compilation errors in grid.rs and inspector.rs (expected - will fix in next tasks)

Note the error locations:
- `grid.rs:41` - comparison with usize
- `grid.rs:60` - setting with usize
- `inspector.rs:23` - reading as Option<usize>
- And more...

**Step 3: Commit type change**

```bash
cd /Users/michaelpolansky/Development/flux
git add flux-app/src/app.rs
git commit -m "refactor: change selected_step to track (track_id, step_idx) tuple

Preparation for 4-track grid layout. Updates SequencerState to use
Option<(usize, usize)> instead of Option<usize>.

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 2: Fix Grid Component Selection Logic

**Files:**
- Modify: `flux-app/src/ui/components/grid.rs:41,60`

**Step 1: Update selection comparison**

Fix the is_selected check (line 41):

```rust
let is_selected = sequencer_state.selected_step.get()
    .map(|(tid, sidx)| tid == track_id && sidx == idx)
    .unwrap_or(false);
```

**Step 2: Update selection setter**

Fix the on:click handler (line 60):

```rust
on:click=move |_| {
    sequencer_state.selected_step.set(Some((track_id, idx)));
}
```

**Step 3: Verify compilation**

Run: `cd flux-app && cargo check`
Expected: Fewer errors (grid.rs fixed, inspector.rs still has errors)

**Step 4: Commit grid selection fix**

```bash
cd /Users/michaelpolansky/Development/flux
git add flux-app/src/ui/components/grid.rs
git commit -m "fix: update grid selection logic for track tuple

Updates grid component to use (track_id, step_idx) tuple for selection
state instead of just step_idx.

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 3: Fix Inspector Component Selection Reads

**Files:**
- Modify: `flux-app/src/ui/components/inspector.rs:23,92,113,135`

**Step 1: Update handle_input selected_step read (line 23)**

```rust
let current_step = sequencer_state.selected_step.get();

set_pattern_signal.update(|p| {
    if let Some(track) = p.tracks.get_mut(track_id) {
        if let Some((sel_track_id, step_idx)) = current_step {
            // P-Lock Mode
            if sel_track_id == track_id {
                if let Some(subtrack) = track.subtracks.get_mut(subtrack_id) {
                    if let Some(step) = subtrack.steps.get_mut(step_idx) {
                        if idx < 128 {
                            step.p_locks[idx] = Some(val as f32);
                        }
                    }
                }
                spawn_local(async move {
                    use crate::ui::tauri::push_midi_command;
                    push_midi_command("param_lock", Some(step_idx), Some(param_name), Some(val)).await;
                });
            }
        } else {
            // Track Default Mode
            if idx < 128 {
                track.default_params[idx] = val as f32;
            }
            spawn_local(async move {
                use crate::ui::tauri::push_midi_command;
                push_midi_command("param_change", None, Some(param_name), Some(val)).await;
            });
        }
    }
});
```

**Step 2: Update get_value selected_step read (line 92)**

```rust
let current_step = sequencer_state.selected_step.get();

pattern_signal.with(|p| {
    if let Some(track) = p.tracks.get(track_id) {
        if let Some((sel_track_id, step_idx)) = current_step {
            if sel_track_id == track_id {
                // Check P-Lock
                track.subtracks.get(subtrack_id)
                    .and_then(|st| st.steps.get(step_idx))
                    .and_then(|s| s.p_locks.get(idx).cloned().flatten())
                    .unwrap_or_else(|| track.default_params.get(idx).cloned().unwrap_or(0.0) as f32) as f64
            } else {
                // Different track selected, show default
                track.default_params.get(idx).cloned().unwrap_or(0.0) as f64
            }
        } else {
            // Track Default
            track.default_params.get(idx).cloned().unwrap_or(0.0) as f64
        }
    } else {
        0.0
    }
})
```

**Step 3: Update is_locked selected_step read (line 113)**

```rust
let current_step = sequencer_state.selected_step.get();

if let Some((sel_track_id, step_idx)) = current_step {
    if sel_track_id == track_id {
        pattern_signal.with(|p| {
            p.tracks.get(track_id)
                .and_then(|t| t.subtracks.get(subtrack_id))
                .and_then(|st| st.steps.get(step_idx))
                .and_then(|s| s.p_locks.get(idx))
                .map(|l| l.is_some())
                .unwrap_or(false)
        })
    } else {
        false
    }
} else {
    false
}
```

**Step 4: Update header text (line 135)**

```rust
{move || {
    if let Some((track_id, step_idx)) = sequencer_state.selected_step.get() {
        format!("Editing: Track {}, Step {}", track_id + 1, step_idx + 1)
    } else {
        "Editing: Track Defaults".to_string()
    }
}}
```

**Step 5: Update Active toggle button (line 145)**

```rust
{move || {
    if let Some((sel_track_id, step_idx)) = sequencer_state.selected_step.get() {
        if sel_track_id == track_id {
            view! {
                <button
                    class=move || {
                        let base = "px-3 py-1 rounded-lg text-xs font-medium transition-all duration-150 flex items-center gap-2";
                        let state = if is_step_active(step_idx) {
                            "bg-amber-500 text-black hover:bg-amber-400"
                        } else {
                            "bg-zinc-700 text-zinc-400 hover:bg-zinc-600"
                        };
                        format!("{} {}", base, state)
                    }
                    on:click=move |_| toggle_step(step_idx)
                >
                    <span class="text-base">{move || if is_step_active(step_idx) { "●" } else { "○" }}</span>
                    "Active"
                </button>
            }.into_any()
        } else {
            view! { <div></div> }.into_any()
        }
    } else {
        view! { <div></div> }.into_any()
    }
}}
```

**Step 6: Verify compilation**

Run: `cd flux-app && cargo check`
Expected: SUCCESS - all type errors resolved

**Step 7: Commit inspector fixes**

```bash
cd /Users/michaelpolansky/Development/flux
git add flux-app/src/ui/components/inspector.rs
git commit -m "fix: update inspector to handle track tuple selection

Updates all selected_step reads to destructure (track_id, step_idx)
tuple and adds track number to header display.

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 4: Update Grid Layout to 4 Tracks × 16 Steps

**Files:**
- Modify: `flux-app/src/ui/components/grid.rs:11-70`

**Step 1: Update grid structure to display 4 tracks**

Replace the entire grid view section (lines 15-70):

```rust
view! {
    <div class="flex">
        // Track labels on the left
        <div class="flex flex-col gap-[2px] mr-2">
            <div class="w-8 h-10 flex items-center justify-center text-xs text-zinc-400">T1</div>
            <div class="w-8 h-10 flex items-center justify-center text-xs text-zinc-400">T2</div>
            <div class="w-8 h-10 flex items-center justify-center text-xs text-zinc-400">T3</div>
            <div class="w-8 h-10 flex items-center justify-center text-xs text-zinc-400">T4</div>
        </div>

        // Grid of 4 tracks × 16 steps
        <div class="flex flex-col gap-[2px]">
            <For
                each=move || {
                    (0..4).into_iter()
                }
                key=|track_idx| *track_idx
                children=move |track_idx| {
                    view! {
                        <div class="grid grid-cols-16 gap-[2px]">
                            <For
                                each=move || {
                                    (0..16).into_iter()
                                }
                                key=|step_idx| *step_idx
                                children=move |step_idx| {
                                    // Create a derived signal for this specific step's active state
                                    let is_active = move || {
                                        pattern_signal.with(|p| {
                                            p.tracks.get(track_idx)
                                                .and_then(|t| t.subtracks.get(subtrack_id))
                                                .and_then(|st| st.steps.get(step_idx))
                                                .map(|s| s.trig_type != crate::shared::models::TrigType::None)
                                                .unwrap_or(false)
                                        })
                                    };

                                    view! {
                                        <button
                                            class=move || {
                                                let base_classes = "w-10 h-10 rounded-lg transition-all duration-100 flex items-center justify-center select-none active:scale-95 focus:outline-none border";

                                                let is_current_step = sequencer_state.current_step.get() == step_idx;
                                                let is_active_note = is_active();
                                                let is_selected = sequencer_state.selected_step.get()
                                                    .map(|(tid, sidx)| tid == track_idx && sidx == step_idx)
                                                    .unwrap_or(false);

                                                let state_classes = if is_active_note {
                                                    "bg-blue-500 border-blue-400"
                                                } else {
                                                    "bg-zinc-800 border-zinc-700 hover:bg-zinc-700"
                                                };

                                                let selection_classes = if is_selected {
                                                    "ring-2 ring-blue-400"
                                                } else {
                                                    ""
                                                };

                                                format!("{} {} {}", base_classes, state_classes, selection_classes)
                                            }
                                            on:click=move |_| {
                                                sequencer_state.selected_step.set(Some((track_idx, step_idx)));
                                            }
                                        >
                                            // Visual indicator: filled circle for active, empty for inactive
                                            <span class=move || {
                                                if is_active() {
                                                    "text-white text-lg"
                                                } else {
                                                    "text-zinc-600 text-lg"
                                                }
                                            }>
                                                {move || if is_active() { "●" } else { "○" }}
                                            </span>
                                        </button>
                                    }
                                }
                            />
                        </div>
                    }
                }
            />
        </div>
    </div>
}
```

**Step 2: Verify compilation**

Run: `cd flux-app && cargo check`
Expected: SUCCESS

**Step 3: Manual visual verification**

Run: `cd flux-app && trunk serve`
Expected:
- Grid displays 4 tracks (T1, T2, T3, T4) with track labels on left
- Each track has 16 steps horizontally
- Buttons are 40×40px (w-10 h-10)
- Grid is approximately 175px tall

**Step 4: Test selection across tracks**

Manual test:
1. Click step 5 on track 1
2. Inspector header should show "Editing: Track 1, Step 5"
3. Click step 10 on track 3
4. Inspector header should show "Editing: Track 3, Step 10"
5. Selected step should have blue ring
6. Press ESC → deselection works
7. Click outside grid → deselection works

**Step 5: Commit grid layout changes**

```bash
cd /Users/michaelpolansky/Development/flux
git add flux-app/src/ui/components/grid.rs
git commit -m "feat: implement 4-track × 16-step dense grid layout

Adds track labels (T1-T4) and displays 4 tracks vertically with 16
steps each. Reduces button size to 40×40px for compact layout.

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 5: Update Click-Away Handler for New Grid Class

**Files:**
- Modify: `flux-app/src/app.rs:78`

**Step 1: Update grid class check**

Change the grid class detection from grid-cols-8 to grid-cols-16:

```rust
while let Some(el) = current {
    let class_list = el.class_list();
    if class_list.contains("grid") && class_list.contains("grid-cols-16") {
        found_grid = true;
        break;
    }
    current = el.parent_element();
}
```

**Step 2: Verify compilation**

Run: `cd flux-app && cargo check`
Expected: SUCCESS

**Step 3: Manual verification**

Test:
1. Click a step → selection works
2. Click outside grid (on background) → deselection works
3. Click in inspector → selection persists
4. ESC key → deselection works

**Step 4: Commit click-away fix**

```bash
cd /Users/michaelpolansky/Development/flux
git add flux-app/src/app.rs
git commit -m "fix: update click-away handler for 16-column grid

Updates grid class check from grid-cols-8 to grid-cols-16 to match
new 4-track layout.

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 6: Comprehensive Manual Testing

**Step 1: Visual layout verification**

Manual checklist:
- [ ] Grid displays 4 tracks with labels T1, T2, T3, T4
- [ ] Each track has 16 steps (buttons)
- [ ] Buttons are 40×40px with 2px gaps
- [ ] Track labels align with their respective rows
- [ ] Total grid height is approximately 175px
- [ ] Grid fits in viewport without scrolling

**Step 2: Selection functionality testing**

Manual checklist:
- [ ] Click step on Track 1 → inspector shows "Editing: Track 1, Step N"
- [ ] Click step on Track 2 → inspector shows "Editing: Track 2, Step N"
- [ ] Click step on Track 3 → inspector shows "Editing: Track 3, Step N"
- [ ] Click step on Track 4 → inspector shows "Editing: Track 4, Step N"
- [ ] Selected step has blue ring highlight
- [ ] Selection moves correctly when clicking different steps

**Step 3: Deselection testing**

Manual checklist:
- [ ] ESC key clears selection → inspector shows "Editing: Track Defaults"
- [ ] Click outside grid clears selection
- [ ] Click in inspector preserves selection

**Step 4: Active toggle testing**

Manual checklist:
- [ ] Select step on Track 1, toggle Active → step becomes active (blue button with filled circle)
- [ ] Select step on Track 2, toggle Active → works independently from Track 1
- [ ] Select step on Track 3, toggle Active → works independently
- [ ] Select step on Track 4, toggle Active → works independently
- [ ] Deselect → Active toggle disappears
- [ ] Re-select → Active toggle shows correct state

**Step 5: Parameter editing testing**

Manual checklist:
- [ ] Select step, adjust parameter → value changes
- [ ] Select different step on same track → shows different p-lock values
- [ ] Select step on different track → shows that track's values
- [ ] Deselect → inspector shows track defaults
- [ ] Parameter labels turn amber when p-locked

**Step 6: Visual consistency testing**

Manual checklist:
- [ ] Button hover states work (zinc-700 on inactive steps)
- [ ] Active steps show blue background (bg-blue-500)
- [ ] Inactive steps show zinc background (bg-zinc-800)
- [ ] Selection ring is visible and distinct
- [ ] Colors consistent with design system (zinc/blue palette)
- [ ] Transitions smooth (duration-100 on buttons)

**Step 7: Document test results**

Create file: `docs/plans/2026-02-13-4-track-grid-test-results.md`

```markdown
# 4-Track Grid Manual Test Results

Date: YYYY-MM-DD
Tester: [Your Name]

## Visual Layout
- [ ] All checks passed
- [ ] Issues: [list any issues]

## Selection Functionality
- [ ] All checks passed
- [ ] Issues: [list any issues]

## Deselection
- [ ] All checks passed
- [ ] Issues: [list any issues]

## Active Toggle
- [ ] All checks passed
- [ ] Issues: [list any issues]

## Parameter Editing
- [ ] All checks passed
- [ ] Issues: [list any issues]

## Visual Consistency
- [ ] All checks passed
- [ ] Issues: [list any issues]

## Overall Status
- [ ] PASS - All tests passed, ready to merge
- [ ] FAIL - Issues found, needs fixes

## Notes
[Any additional observations or notes]
```

**Step 8: Commit test results**

```bash
cd /Users/michaelpolansky/Development/flux
git add docs/plans/2026-02-13-4-track-grid-test-results.md
git commit -m "docs: add 4-track grid manual test results

Test results for 4-track dense grid implementation.

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Implementation Notes

**Design Reference:** `docs/plans/2026-02-13-4-track-grid-design.md`

**Key Architectural Decisions:**
- Selection signal type changed from `Option<usize>` to `Option<(usize, usize)>` to track both track and step
- Grid displays only tracks 0-3 (first 4 of 16 available tracks in pattern)
- Track labels are inline component (no separate file needed)
- All existing Tauri backend commands already support track_id parameter (no backend changes needed)

**Commit Strategy:**
- Task 1: Type change (expected to break compilation)
- Task 2: Fix grid compilation errors
- Task 3: Fix inspector compilation errors
- Task 4: Implement new grid layout
- Task 5: Update click-away handler
- Task 6: Document manual testing

**Visual Testing:**
Use `trunk serve` to run development server and manually verify each change in the browser. No automated UI tests for this milestone.

**Rollback Plan:**
If issues arise, each commit is atomic and can be reverted independently:
```bash
git revert <commit-sha>
```
